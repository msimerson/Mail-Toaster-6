image: auchida/freebsd:latest

before_script:
  - sudo pkg update && sudo pkg install -y ca_root_nss
  - sh test/get_jail_ip.sh
  - echo "export TOASTER_HOSTNAME=`hostname`" >> mail-toaster.conf
  - echo "export TOASTER_MAIL_DOMAIN=`hostname`" >> mail-toaster.conf

stages:
  - mailservices
  - mailstore
  - mta
  - webmail
  - extras

mailservices:
  stage: mailservices
  script:
    - sh provision-host.sh
    - sh provision-base.sh
    - sh provision-dns.sh
    - sh provision-mysql.sh
    - sh provision-redis.sh
  tags:
    - freebsd
    - ssh

mailstore:
  stage: mailstore
  script:
    - sh provision-vpopmail.sh
    - sh provision-dovecot.sh
  tags:
    - freebsd
    - ssh

mta:
  stage: mta
  script:
    - sh provision-vpopmail.sh
    - sh provision-clamav.sh
    - sh provision-rspamd.sh
    - sh provision-geoip.sh
    - sh provision-haraka.sh
  tags:
    - freebsd
    - ssh

webmail:
  stage: webmail
  script:
    - sh provision-haproxy.sh
    - sh provision-webmail.sh
    - sh provision-roundcube.sh
    - sh provision-rainloop.sh
    - sh provision-squirrelmail.sh
  tags:
    - freebsd
    - ssh

extras:
  stage: extras
  script:
    - sh provision-avg.sh
    - sh provision-spamassassin.sh
    - sh provision-sqwebmail.sh
  tags:
    - freebsd
    - ssh
  allow_failure: true


# Test Runner Setup Instructions
# 1. Install GitLab Runner: https://docs.gitlab.com/runner/
# N. Register a runner with the SSH executor and identify_file
#    https://docs.gitlab.com/runner/executors/ssh.html
# 1. Create a new FreeBSD VM, 4GB RAM, 10GB+ Disk
#    (no distributions, Auto ZFS partitioning)
# 2. install ~/.ssh/authorized_keys & /root/.ssh/authorized_keys
# 3. sed -i'' 's/^#PermitRoot.*/PermitRootLogin without-password/'
# 4. pkg update && pkg install -y sudo git-lite open-vm-tools-nox11 vim-lite bash
# N. chpass -s bash $USER && chpass -s bash root
# 5. freebsd-update fetch install
# 6. portsnap fetch extract
# N. service sendmail stop; sysrc sendmail_enable=NONE
# 7. halt -p && take a snapshot